"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3350],{8780:(i,n,e)=>{e.r(n),e.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>l,frontMatter:()=>s,metadata:()=>t,toc:()=>a});var r=e(4848),S=e(8453);const s={},o="Exercise 1",t={id:"PyTorch/nvfuser_exercises/exercise_1",title:"Exercise 1",description:"In this exercise we will:",source:"@site/docs/PyTorch/nvfuser_exercises/exercise_1.md",sourceDirName:"PyTorch/nvfuser_exercises",slug:"/PyTorch/nvfuser_exercises/exercise_1",permalink:"/docs/PyTorch/nvfuser_exercises/exercise_1",draft:!1,unlisted:!1,editUrl:"https://github.com/syed-ahmed/syed-ahmed.github.io/blob/main/website/docs/PyTorch/nvfuser_exercises/exercise_1.md?plain=1",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Getting code coverage info in PyTorch",permalink:"/docs/PyTorch/code_coverage"}},c={},a=[{value:"Reading TorchScript IR",id:"reading-torchscript-ir",level:2},{value:"Lower to Fusion IR",id:"lower-to-fusion-ir",level:2},{value:"nvFuser Basics",id:"nvfuser-basics",level:2}];function d(i){const n={code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,S.R)(),...i.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"exercise-1",children:"Exercise 1"}),"\n",(0,r.jsx)(n.p,{children:"In this exercise we will:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Read a TorchScript IR using ",(0,r.jsx)(n.code,{children:"torch::jit::parseIR"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Lower TorchScript IR to nvFuser Fusion IR using ",(0,r.jsx)(n.code,{children:"torch::jit::fuser::cuda::parseJitIR"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Print the Fusion IR, understand ",(0,r.jsx)(n.code,{children:"parseJitIR"})," and nvFuser basics."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"reading-torchscript-ir",children:"Reading TorchScript IR"}),"\n",(0,r.jsx)(n.p,{children:"In these set of exercises, it doesn't really matter why we are using TorchScript as the input. We want to focus on nvFuser Fusion IR and we can get to Fusion IR from TorchScript IR quickly."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Create a C++ source file and start adding the necessary headers:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"#include <torch/csrc/jit/ir/ir.h>\n#include <torch/csrc/jit/ir/irparser.h>\n\n#include <iostream>\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Create a graph object:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"auto g = torch::jit::Graph();\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Parse a TorchScript IR into the graph object:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:'const auto graph_str = R"IR(\n    graph(%0 : Float(8, 256, 56, 56, strides=[802816, 3136, 56, 1], requires_grad=0, device=cuda:0),\n        %1 : Float(256, strides=[1], requires_grad=0, device=cuda:0),\n        %2 : Float(256, strides=[1], requires_grad=0, device=cuda:0),\n        %3 : Float(256, strides=[1], requires_grad=0, device=cuda:0),\n        %4 : Float(256, strides=[1], requires_grad=0, device=cuda:0),\n        %5 : Float(8, 256, 56, 56, strides=[802816, 3136, 56, 1], requires_grad=0, device=cuda:0),\n        %6 : Float(256, strides=[1], requires_grad=0, device=cuda:0),\n        %7 : Float(256, strides=[1], requires_grad=0, device=cuda:0),\n        %8 : Float(256, strides=[1], requires_grad=0, device=cuda:0),\n        %9 : Float(256, strides=[1], requires_grad=0, device=cuda:0),\n        %10 : int):\n    %11 : float = prim::Constant[value=1.0000000000000001e-05]()\n    %12 : float = prim::Constant[value=0.10000000000000001]()\n    %13 : bool = prim::Constant[value=0]()\n    %14 : Float(8, 256, 56, 56, strides=[802816, 3136, 56, 1], requires_grad=0, device=cuda:0), %15 : Tensor, %16 : Tensor = aten::native_batch_norm(%5, %6, %7, %8, %9, %13, %12, %11)\n    %17 : Float(8, 256, 56, 56, strides=[802816, 3136, 56, 1], requires_grad=0, device=cuda:0), %18 : Tensor, %19 : Tensor = aten::native_batch_norm(%0, %1, %2, %3, %4, %13, %12, %11)\n    %20 : Float(8, 256, 56, 56, strides=[802816, 3136, 56, 1], requires_grad=0, device=cuda:0) = aten::add(%17, %14, %10)\n    %21 : Float(8, 256, 56, 56, strides=[802816, 3136, 56, 1], requires_grad=0, device=cuda:0) = aten::relu(%20)\n    return (%21))IR";\ntorch::jit::parseIR(graph_str, &g);\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Print the graph to convince yourself that the parser did its job:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"std::cout << g << std::endl;\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"lower-to-fusion-ir",children:"Lower to Fusion IR"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["First, add the necessary header to use ",(0,r.jsx)(n.code,{children:"parseJitIR"})," and ",(0,r.jsx)(n.code,{children:"FusionGuard"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"#include <torch/csrc/jit/codegen/cuda/executor.h>\n#include <torch/csrc/jit/codegen/cuda/parser.h>\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["We'll need to make some changes to how we created the graph object. ",(0,r.jsx)(n.code,{children:"parseJitIR"})," expects a ",(0,r.jsx)(n.code,{children:"shared_ptr"})," object. So we'll change our graph creation accordingly:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"auto g = std::make_shared<torch::jit::Graph>();\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Now we can lower TorchScript IR to Fusion IR and print:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"auto fusion = torch::jit::fuser::cuda::parseJitIR(g);\ntorch::jit::fuser::cuda::FusionGuard fg(fusion.get());\nfusion.get()->print();\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"nvfuser-basics",children:"nvFuser Basics"}),"\n",(0,r.jsx)(n.p,{children:"TODO"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-llvm",children:"\n%kernel {\nT22_l[ bS52{1}, iS53{i7}, bS54{1}, bS55{1} ]\n   = broadcast( T3_g[ iS6{i7} ] )\nT23_l[ iS56{i0}, iS57{i2}, iS58{i3}, iS59{i4} ]\n   = T0_g[ iS0{i0}, iS1{i2}, iS2{i3}, iS3{i4} ]\n   - T22_l[ bS52{1}, iS53{i7}, bS54{1}, bS55{1} ];\nT24_l[ iS60{i8} ]\n   = T4_g[ iS7{i8} ]\n   + double(9.9999997473787516e-06);\nT25_l[ iS61{i8} ]\n   = rsqrtf(T24_l[ iS60{i8} ]);\nT26_l[ bS62{1}, iS63{i8}, bS64{1}, bS65{1} ]\n   = broadcast( T25_l[ iS61{i8} ] )\nT29_l[ iS68{i0}, iS69{i2}, iS70{i3}, iS71{i4} ]\n   = T23_l[ iS56{i0}, iS57{i2}, iS58{i3}, iS59{i4} ]\n   * T26_l[ bS62{1}, iS63{i8}, bS64{1}, bS65{1} ];\nT30_l[ bS72{1}, iS73{i5}, bS74{1}, bS75{1} ]\n   = broadcast( T1_g[ iS4{i5} ] )\nT31_l[ iS76{i0}, iS77{i2}, iS78{i3}, iS79{i4} ]\n   = T29_l[ iS68{i0}, iS69{i2}, iS70{i3}, iS71{i4} ]\n   * T30_l[ bS72{1}, iS73{i5}, bS74{1}, bS75{1} ];\nT32_l[ bS80{1}, iS81{i6}, bS82{1}, bS83{1} ]\n   = broadcast( T2_g[ iS5{i6} ] )\nT33_l[ iS84{i0}, iS85{i2}, iS86{i3}, iS87{i4} ]\n   = T31_l[ iS76{i0}, iS77{i2}, iS78{i3}, iS79{i4} ]\n   + T32_l[ bS80{1}, iS81{i6}, bS82{1}, bS83{1} ];\nT10_l[ bS16{1}, iS17{i15}, bS18{1}, bS19{1} ]\n   = broadcast( T8_g[ iS14{i15} ] )\nT11_l[ iS20{i9}, iS21{i10}, iS22{i11}, iS23{i12} ]\n   = T5_g[ iS8{i9}, iS9{i10}, iS10{i11}, iS11{i12} ]\n   - T10_l[ bS16{1}, iS17{i15}, bS18{1}, bS19{1} ];\nT12_l[ iS24{i16} ]\n   = T9_g[ iS15{i16} ]\n   + double(9.9999997473787516e-06);\nT13_l[ iS25{i16} ]\n   = rsqrtf(T12_l[ iS24{i16} ]);\nT14_l[ bS26{1}, iS27{i16}, bS28{1}, bS29{1} ]\n   = broadcast( T13_l[ iS25{i16} ] )\nT17_l[ iS32{i9}, iS33{i10}, iS34{i11}, iS35{i12} ]\n   = T11_l[ iS20{i9}, iS21{i10}, iS22{i11}, iS23{i12} ]\n   * T14_l[ bS26{1}, iS27{i16}, bS28{1}, bS29{1} ];\nT18_l[ bS36{1}, iS37{i13}, bS38{1}, bS39{1} ]\n   = broadcast( T6_g[ iS12{i13} ] )\nT19_l[ iS40{i9}, iS41{i10}, iS42{i11}, iS43{i12} ]\n   = T17_l[ iS32{i9}, iS33{i10}, iS34{i11}, iS35{i12} ]\n   * T18_l[ bS36{1}, iS37{i13}, bS38{1}, bS39{1} ];\nT20_l[ bS44{1}, iS45{i14}, bS46{1}, bS47{1} ]\n   = broadcast( T7_g[ iS13{i14} ] )\nT21_l[ iS48{i9}, iS49{i10}, iS50{i11}, iS51{i12} ]\n   = T19_l[ iS40{i9}, iS41{i10}, iS42{i11}, iS43{i12} ]\n   + T20_l[ bS44{1}, iS45{i14}, bS46{1}, bS47{1} ];\nd116 = (double)(i17);\nT34_l[ iS88{i9}, iS89{i10}, iS90{i11}, iS91{i12} ]\n   = T21_l[ iS48{i9}, iS49{i10}, iS50{i11}, iS51{i12} ]\n   * d116;\nT35_l[ iS92{i0}, iS93{i2}, iS94{i3}, iS95{i4} ]\n   = T33_l[ iS84{i0}, iS85{i2}, iS86{i3}, iS87{i4} ]\n   + T34_l[ iS88{i9}, iS89{i10}, iS90{i11}, iS91{i12} ];\nT36_g[ iS96{i0}, iS97{i2}, iS98{i3}, iS99{i4} ]\n   = relu(T35_l[ iS92{i0}, iS93{i2}, iS94{i3}, iS95{i4} ]);\n\nTransformPrinter : \nT0_g[ iS0{i0}, iS1{i2}, iS2{i3}, iS3{i4} ]\n root domain : (iS0{i0},iS1{i2},iS2{i3},iS3{i4})\nT3_g[ iS6{i7} ]\n root domain : (iS6{i7})\nT22_l[ bS52{1}, iS53{i7}, bS54{1}, bS55{1} ]\n root domain : (bS52{1},iS53{i7},bS54{1},bS55{1})\nT23_l[ iS56{i0}, iS57{i2}, iS58{i3}, iS59{i4} ]\n root domain : (iS56{i0},iS57{i2},iS58{i3},iS59{i4})\nT4_g[ iS7{i8} ]\n root domain : (iS7{i8})\nT24_l[ iS60{i8} ]\n root domain : (iS60{i8})\nT25_l[ iS61{i8} ]\n root domain : (iS61{i8})\nT26_l[ bS62{1}, iS63{i8}, bS64{1}, bS65{1} ]\n root domain : (bS62{1},iS63{i8},bS64{1},bS65{1})\nT29_l[ iS68{i0}, iS69{i2}, iS70{i3}, iS71{i4} ]\n root domain : (iS68{i0},iS69{i2},iS70{i3},iS71{i4})\nT1_g[ iS4{i5} ]\n root domain : (iS4{i5})\nT30_l[ bS72{1}, iS73{i5}, bS74{1}, bS75{1} ]\n root domain : (bS72{1},iS73{i5},bS74{1},bS75{1})\nT31_l[ iS76{i0}, iS77{i2}, iS78{i3}, iS79{i4} ]\n root domain : (iS76{i0},iS77{i2},iS78{i3},iS79{i4})\nT2_g[ iS5{i6} ]\n root domain : (iS5{i6})\nT32_l[ bS80{1}, iS81{i6}, bS82{1}, bS83{1} ]\n root domain : (bS80{1},iS81{i6},bS82{1},bS83{1})\nT33_l[ iS84{i0}, iS85{i2}, iS86{i3}, iS87{i4} ]\n root domain : (iS84{i0},iS85{i2},iS86{i3},iS87{i4})\nT5_g[ iS8{i9}, iS9{i10}, iS10{i11}, iS11{i12} ]\n root domain : (iS8{i9},iS9{i10},iS10{i11},iS11{i12})\nT8_g[ iS14{i15} ]\n root domain : (iS14{i15})\nT10_l[ bS16{1}, iS17{i15}, bS18{1}, bS19{1} ]\n root domain : (bS16{1},iS17{i15},bS18{1},bS19{1})\nT11_l[ iS20{i9}, iS21{i10}, iS22{i11}, iS23{i12} ]\n root domain : (iS20{i9},iS21{i10},iS22{i11},iS23{i12})\nT9_g[ iS15{i16} ]\n root domain : (iS15{i16})\nT12_l[ iS24{i16} ]\n root domain : (iS24{i16})\nT13_l[ iS25{i16} ]\n root domain : (iS25{i16})\nT14_l[ bS26{1}, iS27{i16}, bS28{1}, bS29{1} ]\n root domain : (bS26{1},iS27{i16},bS28{1},bS29{1})\nT17_l[ iS32{i9}, iS33{i10}, iS34{i11}, iS35{i12} ]\n root domain : (iS32{i9},iS33{i10},iS34{i11},iS35{i12})\nT6_g[ iS12{i13} ]\n root domain : (iS12{i13})\nT18_l[ bS36{1}, iS37{i13}, bS38{1}, bS39{1} ]\n root domain : (bS36{1},iS37{i13},bS38{1},bS39{1})\nT19_l[ iS40{i9}, iS41{i10}, iS42{i11}, iS43{i12} ]\n root domain : (iS40{i9},iS41{i10},iS42{i11},iS43{i12})\nT7_g[ iS13{i14} ]\n root domain : (iS13{i14})\nT20_l[ bS44{1}, iS45{i14}, bS46{1}, bS47{1} ]\n root domain : (bS44{1},iS45{i14},bS46{1},bS47{1})\nT21_l[ iS48{i9}, iS49{i10}, iS50{i11}, iS51{i12} ]\n root domain : (iS48{i9},iS49{i10},iS50{i11},iS51{i12})\nT34_l[ iS88{i9}, iS89{i10}, iS90{i11}, iS91{i12} ]\n root domain : (iS88{i9},iS89{i10},iS90{i11},iS91{i12})\nT35_l[ iS92{i0}, iS93{i2}, iS94{i3}, iS95{i4} ]\n root domain : (iS92{i0},iS93{i2},iS94{i3},iS95{i4})\nT36_g[ iS96{i0}, iS97{i2}, iS98{i3}, iS99{i4} ]\n root domain : (iS96{i0},iS97{i2},iS98{i3},iS99{i4})\n}\n\n"})})]})}function l(i={}){const{wrapper:n}={...(0,S.R)(),...i.components};return n?(0,r.jsx)(n,{...i,children:(0,r.jsx)(d,{...i})}):d(i)}},8453:(i,n,e)=>{e.d(n,{R:()=>o,x:()=>t});var r=e(6540);const S={},s=r.createContext(S);function o(i){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof i?i(n):{...n,...i}}),[n,i])}function t(i){let n;return n=i.disableParentContext?"function"==typeof i.components?i.components(S):i.components||S:o(i.components),r.createElement(s.Provider,{value:n},i.children)}}}]);